# Agentic Memory Storage Agent

The Storage Agent is the foundation component of the Agentic Memory system, responsible for storing and retrieving trading feature vectors using LanceDB.

## Overview

This service receives feature vectors from the Matching Engine (ME) when positions are closed, stores them in LanceDB with complete metadata, and provides query capabilities for the Gradient Analyzer and Risk Management agents.

## Features

- **LanceDB Integration**: Efficient vector storage with built-in similarity search
- **94+ Feature Vector Schema**: Dynamic feature support with graduated similarity matching
- **Complete Outcome Tracking**: Stores risk parameters, PnL, holding times, exit reasons
- **Position Size Normalization**: Stores both raw PnL and normalized per-contract values
- **Trajectory Data**: Captures bar-by-bar profit progression for pattern analysis
- **High Performance**: Non-blocking storage, fast similarity queries
- **Robust Error Handling**: Fails gracefully without affecting ME operations

## API Endpoints

### POST /api/store-vector
Store a feature vector from position deregistration.

**Request Body:**
```json
{
  "entrySignalId": "signal_12345",
  "instrument": "MGC", 
  "timestamp": 1641234567890,
  "entryType": "ORDER_FLOW_IMBALANCE",
  "direction": "long",
  "quantity": 2,  // Number of contracts traded
  "features": {    // Object with named features (94+ features)
    "atr_percentage": 0.15,
    "volume_delta": 1234,
    "rsi_14": 65.5,
    // ... more features
  },
  "riskUsed": {
    "stopLoss": 15.0,
    "takeProfit": 25.0,
    "virtualStop": 20.0
  },
  "outcome": {
    "pnl": 250.0,
    "pnlPoints": 12.5,
    "pnlPerContract": 125.0,  // CRITICAL: Normalized PnL per contract
    "pnlPointsPerContract": 6.25,  // Normalized points per contract
    "holdingBars": 8,
    "exitReason": "take_profit",
    "maxProfit": 15.0,
    "maxLoss": -5.0,
    "wasGoodExit": true,
    "profitByBar": {  // Bar-by-bar profit trajectory
      "0": 0,
      "1": -5,
      "2": -10,
      "3": 5,
      "4": 20,
      "5": 35,
      "6": 50,
      "7": 125
    }
  }
}
```

### POST /api/query-similar
Find similar historical patterns for risk optimization.

**Request Body:**
```json
{
  "features": {  // Query features as object
    "atr_percentage": 0.15,
    "volume_delta": 1234,
    // ... more features
  },
  "instrument": "MGC",  // Instrument-specific queries
  "direction": "long",   // Direction-specific queries
  "entryType": "ORDER_FLOW_IMBALANCE",
  "limit": 100,
  "similarity_threshold": 0.85,
  "graduatedFeatures": [  // Optional: Specific features for similarity
    "atr_percentage",
    "volume_delta",
    "rsi_14"
  ]
}
```

### GET /api/vectors
Retrieve vectors for gradient analysis.

**Query Parameters:**
- `instrument`: Filter by instrument (e.g., "MGC")
- `since`: ISO timestamp for time-based filtering
- `limit`: Maximum number of results (default: 1000)
- `entryType`: Filter by entry type

### GET /api/stats
Get storage statistics and health information.

### GET /health
Health check endpoint.

## Feature Schema

The system now supports 94+ dynamic features generated by NinjaTrader:

### Core Feature Categories:
1. **ATR/Volatility**: atr_14, atr_percentage, atr_ratio
2. **Volume Analysis**: volume, volume_sma, volume_ratio, volume_delta, cumulative_delta
3. **Price Action**: open, high, low, close, vwap, body_size, upper_wick, lower_wick
4. **Technical Indicators**: rsi_14, macd, macd_signal, bb_upper, bb_lower, bb_width
5. **Market Structure**: higher_highs, lower_lows, inside_bar, outside_bar
6. **Order Flow**: bid_volume, ask_volume, delta_percentage, buy_sell_ratio
7. **Moving Averages**: ema_9, ema_21, sma_50, sma_200, ema_distance
8. **Pattern Recognition**: doji, hammer, shooting_star, engulfing

### Critical Normalized Fields:
- **pnlPerContract**: PnL divided by number of contracts (for fair comparison)
- **pnlPointsPerContract**: Points divided by number of contracts
- **profitByBar**: Dictionary/object tracking profit at each bar
- **quantity**: Number of contracts traded (position size)

## Installation

```bash
npm install
```

## Configuration

Copy `.env.example` to `.env` and configure:

```bash
# Server Configuration
STORAGE_PORT=3015

# LanceDB Configuration  
LANCEDB_PATH=./data/vectors

# Data Retention
VECTOR_RETENTION_DAYS=90
```

## Usage

### Development
```bash
npm run dev
```

### Production
```bash
npm start
```

### Testing
```bash
npm test
```

### Docker
```bash
docker-compose up storage-agent
```

## Integration with ME

The Storage Agent integrates with the Matching Engine's `positionTrackingService.js` through the `agenticMemoryClient`. When enabled with `AGENTIC_MEMORY_ENABLED=true`, the ME automatically sends feature vectors to this service on position close.

## Performance

- **Storage Rate**: >100 vectors/second
- **Query Response**: <50ms for similarity search (with graduated features)
- **Memory Usage**: ~512MB base + vector data
- **Storage Format**: Apache Arrow/Parquet (LanceDB)
- **In-Memory Caching**: Risk service maintains memory-based graduation tables
- **Normalization**: All PnL calculations use per-contract values for fair comparison

## Monitoring

Key metrics to monitor:

- Vector insertion rate (`/api/stats`)
- Storage size growth
- Query response times
- Error rates in logs

## Future Integration

This Storage Agent is designed to work with:

- **Gradient Analyzer**: Queries vectors for feature importance analysis
- **Risk Management Agent**: Uses similarity search for dynamic risk calculation
- **Monitoring Dashboard**: Real-time statistics and performance metrics

## Error Handling

The service is designed to fail gracefully:

- ME integration is non-blocking (uses `setImmediate`)
- Storage failures don't affect position deregistration
- Automatic retry logic with exponential backoff
- Comprehensive error logging

## Security

- Input validation on all endpoints
- Request size limits (10MB)
- No sensitive data exposure in logs
- Health checks for monitoring